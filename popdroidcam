#!/bin/bash

STATE_DIR="$HOME/.local/state/popdroidcam"
PID_FILE="$STATE_DIR/pid"
CONFIG_FILE="$STATE_DIR/config"

SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
    DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd "$(dirname "$SOURCE")" && pwd)"

mkdir -p "$STATE_DIR"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

find_v4l2_device() {
    for name_file in /sys/devices/virtual/video4linux/video*/name; do
        if [ -f "$name_file" ]; then
            name=$(cat "$name_file" 2>/dev/null)
            if [[ "$name" == *"PopDroidCam"* ]] || [[ "$name" == *"Android"* ]] || [[ "$name" == *"v4l2loopback"* ]]; then
                device=$(basename "$(dirname "$name_file")")
                echo "/dev/$device"
                return 0
            fi
        fi
    done
    echo "/dev/video6"
}

ensure_v4l2loopback() {
    if ! lsmod | grep -q v4l2loopback; then
        echo -e "${YELLOW}Loading v4l2loopback module...${NC}"
        sudo modprobe v4l2loopback card_label="PopDroidCam" exclusive_caps=1
        sleep 1
    fi
}

is_running() {
    if [ -f "$PID_FILE" ]; then
        pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            return 0
        fi
    fi
    return 1
}

get_battery_info() {
    local serial="$1"
    local battery_output
    if [ -n "$serial" ]; then
        battery_output=$(adb -s "$serial" shell dumpsys battery 2>/dev/null)
    else
        battery_output=$(adb shell dumpsys battery 2>/dev/null)
    fi
    
    local level=$(echo "$battery_output" | grep -E "^\s*level:" | sed 's/.*level:\s*//')
    local status=$(echo "$battery_output" | grep -E "^\s*status:" | sed 's/.*status:\s*//')
    
    if [ -n "$level" ]; then
        local charging=""
        if [ "$status" == "2" ]; then
            charging="âš¡"
        fi
        echo "${level}%${charging}"
    fi
}

cmd_start() {
    if is_running; then
        echo -e "${YELLOW}Camera already running (PID: $(cat "$PID_FILE"))${NC}"
        echo "Use 'popdroidcam stop' to stop it first."
        exit 1
    fi

    local res="1920x1080"
    local fps="30"
    local camera="back"
    local camera_id=""
    local device=""
    local rotation="0"
    local quality="high"
    local bitrate="16M"
    local mirror="off"
    local zoom="1x"

    while [[ $# -gt 0 ]]; do
        case $1 in
            --res)
                case $2 in
                    1080p|1080) res="1920x1080" ;;
                    4k|4K|2160p) res="3840x2160" ;;
                    720p|720) res="1280x720" ;;
                    *) res="$2" ;;
                esac
                shift 2
                ;;
            --fps)
                fps="$2"
                shift 2
                ;;
            --camera)
                camera="$2"
                shift 2
                ;;
            --camera-id|--id)
                camera_id="$2"
                shift 2
                ;;
            --device|-s)
                device="$2"
                shift 2
                ;;
            --rotation|--rotate)
                case $2 in
                    0|90|180|270) rotation="$2" ;;
                    *) echo -e "${RED}Invalid rotation. Use 0, 90, 180, or 270.${NC}"; exit 1 ;;
                esac
                shift 2
                ;;
            --quality|-q)
                case $2 in
                    low) quality="low"; bitrate="4M" ;;
                    medium) quality="medium"; bitrate="8M" ;;
                    high) quality="high"; bitrate="16M" ;;
                    ultra) quality="ultra"; bitrate="32M" ;;
                    *) echo -e "${RED}Invalid quality. Use low, medium, high, or ultra.${NC}"; exit 1 ;;
                esac
                shift 2
                ;;
            --bitrate|-b)
                bitrate="$2"
                quality="custom"
                shift 2
                ;;
            --mirror)
                case $2 in
                    on|off) mirror="$2" ;;
                    *) echo -e "${RED}Invalid mirror value. Use on or off.${NC}"; exit 1 ;;
                esac
                shift 2
                ;;
            --zoom)
                case $2 in
                    1x|1.5x|2x|3x|4x) zoom="$2" ;;
                    *) echo -e "${RED}Invalid zoom level. Use 1x, 1.5x, 2x, 3x, or 4x.${NC}"; exit 1 ;;
                esac
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done

    if ! adb devices 2>/dev/null | grep -q "\sdevice$"; then
        echo -e "${RED}No Android device connected or authorized.${NC}"
        echo "Enable USB debugging and reconnect your phone."
        exit 1
    fi

    ensure_v4l2loopback
    local v4l2_device=$(find_v4l2_device)

    echo -e "${CYAN}Starting camera stream...${NC}"
    echo "  Resolution: $res"
    echo "  FPS: $fps"
    echo "  Quality: $quality ($bitrate)"
    if [ -n "$camera_id" ]; then
        echo "  Camera ID: $camera_id"
    else
        echo "  Camera: $camera"
    fi
    echo "  Device: $v4l2_device"
    if [ "$rotation" != "0" ]; then
        echo "  Rotation: ${rotation}Â°"
    fi
    if [ "$mirror" == "on" ]; then
        echo "  Mirror: on"
    fi
    if [ "$zoom" != "1x" ]; then
        echo "  Zoom: $zoom"
    fi
    if [ -n "$device" ]; then
        echo "  Phone: $device"
    fi

    local scrcpy_cmd="scrcpy --video-source=camera --camera-size=$res --camera-fps=$fps --video-bit-rate=$bitrate --v4l2-sink=$v4l2_device --no-window --no-audio"
    if [ -n "$camera_id" ]; then
        scrcpy_cmd="$scrcpy_cmd --camera-id=$camera_id"
    else
        scrcpy_cmd="$scrcpy_cmd --camera-facing=$camera"
    fi
    if [ -n "$device" ]; then
        scrcpy_cmd="$scrcpy_cmd --serial=$device"
    fi
    if [ "$mirror" == "on" ] || [ "$rotation" != "0" ]; then
        if [ "$mirror" == "on" ]; then
            scrcpy_cmd="$scrcpy_cmd --capture-orientation=flip$rotation"
        else
            scrcpy_cmd="$scrcpy_cmd --capture-orientation=$rotation"
        fi
    fi
    if [ "$zoom" != "1x" ]; then
        local orig_w=$(echo "$res" | cut -dx -f1)
        local orig_h=$(echo "$res" | cut -dx -f2)
        local factor
        case $zoom in
            1.5x) factor="1.5" ;;
            2x) factor="2" ;;
            3x) factor="3" ;;
            4x) factor="4" ;;
            *) factor="1" ;;
        esac
        local crop_w=$(echo "$orig_w / $factor" | bc)
        local crop_h=$(echo "$orig_h / $factor" | bc)
        local crop_x=$(echo "($orig_w - $crop_w) / 2" | bc)
        local crop_y=$(echo "($orig_h - $crop_h) / 2" | bc)
        scrcpy_cmd="$scrcpy_cmd --crop=$crop_w:$crop_h:$crop_x:$crop_y"
    fi

    nohup $scrcpy_cmd > "$STATE_DIR/scrcpy.log" 2>&1 &

    local pid=$!
    sleep 2

    if ps -p $pid > /dev/null 2>&1; then
        echo "$pid" > "$PID_FILE"
        echo "res=$res" > "$CONFIG_FILE"
        echo "fps=$fps" >> "$CONFIG_FILE"
        echo "camera=$camera" >> "$CONFIG_FILE"
        echo "device=$v4l2_device" >> "$CONFIG_FILE"
        echo "rotation=$rotation" >> "$CONFIG_FILE"
        echo "quality=$quality" >> "$CONFIG_FILE"
        echo "bitrate=$bitrate" >> "$CONFIG_FILE"
        echo "mirror=$mirror" >> "$CONFIG_FILE"
        echo "zoom=$zoom" >> "$CONFIG_FILE"
        echo "started=$(date -Iseconds)" >> "$CONFIG_FILE"
        
        echo -e "${GREEN}âœ“ Camera started (PID: $pid)${NC}"
        echo "Select 'PopDroidCam' in your video apps."
    else
        echo -e "${RED}âœ— Failed to start camera${NC}"
        echo "Check logs: cat $STATE_DIR/scrcpy.log"
        exit 1
    fi
}

cmd_stop() {
    if ! is_running; then
        echo -e "${YELLOW}Camera is not running.${NC}"
        exit 0
    fi

    local pid=$(cat "$PID_FILE")
    echo -e "${CYAN}Stopping camera (PID: $pid)...${NC}"
    kill "$pid" 2>/dev/null
    sleep 1

    if ps -p "$pid" > /dev/null 2>&1; then
        kill -9 "$pid" 2>/dev/null
    fi

    rm -f "$PID_FILE"
    echo -e "${GREEN}âœ“ Camera stopped${NC}"
}

cmd_status() {
    echo -e "${CYAN}=== PopDroidCam Status ===${NC}"
    echo ""

    if is_running; then
        local pid=$(cat "$PID_FILE")
        echo -e "Stream: ${GREEN}Running${NC} (PID: $pid)"
        
        if [ -f "$CONFIG_FILE" ]; then
            echo ""
            echo "Current settings:"
            while IFS='=' read -r key value; do
                printf "  %-10s %s\n" "$key:" "$value"
            done < "$CONFIG_FILE"
        fi
    else
        echo -e "Stream: ${RED}Stopped${NC}"
    fi

    echo ""
    echo "Device:"
    local device_line=$(adb devices 2>/dev/null | grep -E "\s(device|unauthorized)$" | head -1)
    if [ -n "$device_line" ]; then
        local device=$(echo "$device_line" | cut -f1)
        local state=$(echo "$device_line" | cut -f2)
        local battery=""
        if [ "$state" == "device" ]; then
            battery=$(get_battery_info "$device")
        fi
        local battery_display=""
        if [ -n "$battery" ]; then
            battery_display=" [ðŸ”‹ $battery]"
        fi
        if [[ "$device" == *":"* ]]; then
            echo -e "  Phone: ${GREEN}Connected (WiFi)${NC} ($device)$battery_display"
        else
            echo -e "  Phone: ${GREEN}Connected (USB)${NC} ($device)$battery_display"
        fi
        if [ "$state" == "unauthorized" ]; then
            echo -e "         ${YELLOW}âš  Unauthorized - accept prompt on phone${NC}"
        fi
    else
        echo -e "  Phone: ${RED}Not connected${NC}"
    fi

    local v4l2_device=$(find_v4l2_device)
    if [ -e "$v4l2_device" ]; then
        echo -e "  V4L2:  ${GREEN}$v4l2_device${NC}"
    else
        echo -e "  V4L2:  ${RED}Not found${NC}"
    fi
}

cmd_list() {
    echo -e "${CYAN}=== Available Cameras ===${NC}"
    echo ""
    
    if ! adb devices 2>/dev/null | grep -q "\sdevice$"; then
        echo -e "${RED}No Android device connected.${NC}"
        exit 1
    fi

    # Get detailed camera sizes
    local output=$(scrcpy --video-source=camera --list-camera-sizes 2>&1)
    
    local device_info=$(echo "$output" | grep -E "^\[server\] INFO: Device:" | sed 's/\[server\] INFO: Device: //')
    if [ -n "$device_info" ]; then
        echo -e "Device: ${GREEN}$device_info${NC}"
        echo ""
    fi

    echo "Available cameras:"
    
    local current_cam=""
    echo "$output" | while IFS= read -r line; do
        # Camera header line
        if [[ "$line" =~ --camera-id=([0-9]+).*\(([^,]+),.*fps=\[([^\]]+)\] ]]; then
            local id="${BASH_REMATCH[1]}"
            local facing="${BASH_REMATCH[2]}"
            local fps_list="${BASH_REMATCH[3]}"
            echo ""
            echo -e "  ${CYAN}Camera $id${NC} ($facing)"
            echo "    FPS: $fps_list"
            echo "    Resolutions:"
            current_cam="$id"
        # Resolution line
        elif [[ "$line" =~ ^[[:space:]]+-[[:space:]]+([0-9]+x[0-9]+) ]]; then
            local res="${BASH_REMATCH[1]}"
            # Highlight recommended resolutions
            if [[ "$res" == "1920x1080" || "$res" == "1280x720" || "$res" == "3840x2160" ]]; then
                echo -e "      ${GREEN}$res${NC} (recommended)"
            else
                echo "      $res"
            fi
        fi
    done
    
    echo ""
    echo -e "${YELLOW}Recommended resolutions:${NC}"
    echo "  1920x1080 (1080p) - Best compatibility"
    echo "  1280x720 (720p)   - Lower bandwidth"
    echo "  3840x2160 (4K)    - If your phone supports it"
    echo ""
    echo -e "${YELLOW}Note:${NC} Native camera resolution (e.g. 4080x3060) may fail due to"
    echo "      hardware encoder limitations. Use recommended resolutions for best results."
}

cmd_devices() {
    echo -e "${CYAN}=== Connected Devices ===${NC}"
    echo ""
    
    echo "Android devices:"
    adb devices -l 2>/dev/null | tail -n +2 | while read line; do
        if [ -n "$line" ]; then
            local serial=$(echo "$line" | awk '{print $1}')
            local state=$(echo "$line" | awk '{print $2}')
            local model=$(echo "$line" | grep -oP 'model:\K\S+' | tr '_' ' ')
            local battery=""
            
            if [ "$state" == "device" ]; then
                battery=$(get_battery_info "$serial")
            fi
            
            if [ -n "$model" ]; then
                if [ -n "$battery" ]; then
                    echo -e "  ${GREEN}$model${NC} ($serial) - $state [ðŸ”‹ $battery]"
                else
                    echo -e "  ${GREEN}$model${NC} ($serial) - $state"
                fi
            else
                if [ -n "$battery" ]; then
                    echo "  $serial - $state [ðŸ”‹ $battery]"
                else
                    echo "  $serial - $state"
                fi
            fi
        fi
    done

    echo ""
    echo "Video devices:"
    v4l2-ctl --list-devices 2>/dev/null || echo "  v4l2-ctl not available"
}

cmd_connect() {
    local ip="$1"
    local port="${2:-5555}"
    
    if [ -z "$ip" ]; then
        echo -e "${RED}Usage: popdroidcam connect <ip> [port]${NC}"
        echo ""
        echo "To find your phone's IP and port:"
        echo "  1. Enable Wireless debugging (Settings â†’ Developer Options â†’ Wireless debugging)"
        echo "  2. Tap 'Pair device with pairing code' for first-time setup"
        echo "  3. Note the IP address and Port shown"
        echo ""
        echo "Example:"
        echo "  popdroidcam connect 192.168.1.100 5555"
        exit 1
    fi
    
    echo -e "${CYAN}Connecting to $ip:$port...${NC}"
    
    if adb connect "$ip:$port" 2>&1 | grep -q "connected"; then
        echo -e "${GREEN}âœ“ Connected to $ip:$port${NC}"
        echo ""
        echo "Now you can use: popdroidcam start"
    else
        echo -e "${RED}âœ— Failed to connect${NC}"
        echo ""
        echo "Troubleshooting:"
        echo "  1. Ensure phone and PC are on same WiFi network"
        echo "  2. Check Wireless debugging is enabled on phone"
        echo "  3. Try pairing first: popdroidcam pair <ip> <port>"
        exit 1
    fi
}

cmd_pair() {
    local ip="$1"
    local port="$2"
    local code="$3"
    
    if [ -z "$ip" ] || [ -z "$port" ]; then
        echo -e "${RED}Usage: popdroidcam pair <ip> <port> <code>${NC}"
        echo ""
        echo "To pair your phone:"
        echo "  1. Enable Wireless debugging (Settings â†’ Developer Options â†’ Wireless debugging)"
        echo "  2. Tap 'Pair device with pairing code'"
        echo "  3. Note the IP, Port, and Pairing code shown"
        echo ""
        echo "Example:"
        echo "  popdroidcam pair 192.168.1.100 37123 123456"
        exit 1
    fi
    
    if [ -z "$code" ]; then
        echo -e "${RED}Error: Pairing code is required${NC}"
        echo "Usage: popdroidcam pair <ip> <port> <code>"
        exit 1
    fi
    
    echo -e "${CYAN}Pairing with $ip:$port using code $code...${NC}"
    
    local output=$(adb pair "$ip:$port" "$code" 2>&1)
    echo "$output"
    
    if echo "$output" | grep -qi "success\|paired"; then
        echo -e "${GREEN}âœ“ Paired successfully${NC}"
        echo ""
        echo "Now connect with: popdroidcam connect <ip> <port>"
        echo "(Use the port from 'Wireless debugging' screen, not the pairing port)"
    else
        echo -e "${RED}âœ— Pairing failed${NC}"
        echo ""
        echo "Troubleshooting:"
        echo "  1. Make sure the pairing code is still valid (they expire quickly)"
        echo "  2. Tap 'Pair device with pairing code' again for a fresh code"
        echo "  3. Ensure phone and PC are on same WiFi network"
        exit 1
    fi
}

cmd_disconnect() {
    echo -e "${CYAN}Disconnecting all wireless devices...${NC}"
    adb disconnect
    echo -e "${GREEN}âœ“ Disconnected${NC}"
}

cmd_qr() {
    cd "$SCRIPT_DIR"
    bun run src/qr-pair.ts
}

cmd_ui() {
    ensure_v4l2loopback
    cd "$SCRIPT_DIR"
    bun run src/gui/server.ts
}

cmd_desktop() {
    ensure_v4l2loopback
    cd "$SCRIPT_DIR"
    
    # Check if dist exists, if not build first
    if [ ! -f "dist/desktop/main.js" ]; then
        echo -e "${CYAN}Building desktop app...${NC}"
        bun run desktop:build
    fi
    
    # Launch electron
    echo -e "${GREEN}Launching PopDroidCam Desktop...${NC}"
    npx electron dist/desktop/main.js &
}

cmd_help() {
    echo "PopDroidCam - Use Android phone as webcam"
    echo ""
    echo "Usage: popdroidcam [command] [options]"
    echo ""
    echo "Commands:"
    echo "  (none)      Launch interactive TUI"
    echo "  desktop     Launch desktop GUI app (Electron)"
    echo "  ui          Launch web-based GUI (opens in browser)"
    echo "  start       Start camera stream in background"
    echo "  stop        Stop camera stream"
    echo "  status      Show current status"
    echo "  list        List available cameras on phone with resolutions and IDs"
    echo "  devices     List connected devices"
    echo "  qr          Show QR code for easy wireless pairing"
    echo "  pair        Pair with phone manually (ip, port, code)"
    echo "  connect     Connect to phone over WiFi"
    echo "  disconnect  Disconnect wireless devices"
    echo "  help        Show this help"
    echo ""
    echo "Start options:"
    echo "  --res         Resolution: 720p, 1080p, 4k, or custom (e.g. 4080x3060)"
    echo "  --fps         Frame rate: 10, 15, 20, 24, 30 (default)"
    echo "  --camera      Camera facing: back (default), front"
    echo "  --camera-id   Camera ID for specific lens (use 'list' to see IDs)"
    echo "  --rotation    Rotate camera: 0 (default), 90, 180, 270"
    echo "  --mirror      Mirror/flip video horizontally: off (default), on"
    echo "  --zoom        Digital zoom level: 1x (default), 1.5x, 2x, 3x, 4x"
    echo "  --quality     Video quality: low (4M), medium (8M), high (16M, default), ultra (32M)"
    echo "  --bitrate     Custom bitrate (e.g. 20M, 25M) - overrides --quality"
    echo "  --device      Select device by serial (for multiple phones)"
    echo ""
    echo "Quality presets:"
    echo "  low     4 Mbps   - Lower quality, saves bandwidth"
    echo "  medium  8 Mbps   - Balanced (scrcpy default)"
    echo "  high    16 Mbps  - Good quality (recommended)"
    echo "  ultra   32 Mbps  - Best quality, highest bandwidth"
    echo ""
    echo "Camera selection:"
    echo "  Use --camera for simple back/front selection."
    echo "  Use --camera-id for specific lens (wide, ultrawide, telephoto)."
    echo "  Run 'popdroidcam list' to see available camera IDs on your phone."
    echo ""
    echo "Wireless setup:"
    echo "  Option 1 - QR code (easiest):"
    echo "    popdroidcam qr"
    echo "    Then scan with phone: Wireless debugging â†’ Pair with QR code"
    echo ""
    echo "  Option 2 - Manual pairing:"
    echo "    popdroidcam pair <ip> <pairing-port> <code>"
    echo "    popdroidcam connect <ip> <port>"
    echo ""
    echo "Examples:"
    echo "  popdroidcam desktop                    # Launch desktop app"
    echo "  popdroidcam start"
    echo "  popdroidcam start --res 4k --fps 30"
    echo "  popdroidcam start --quality ultra      # Best quality"
    echo "  popdroidcam start --bitrate 20M        # Custom bitrate"
    echo "  popdroidcam start --mirror on          # Mirror/flip horizontally"
    echo "  popdroidcam start --zoom 2x            # 2x digital zoom"
    echo "  popdroidcam start --camera-id 0        # Use specific camera lens"
    echo "  popdroidcam start --camera-id 2        # Use another lens (e.g. wide)"
    echo "  popdroidcam start --device 192.168.1.100:5555"
    echo "  popdroidcam list                       # See available cameras"
    echo "  popdroidcam qr"
    echo "  popdroidcam stop"
}

case "${1:-}" in
    start)
        shift
        cmd_start "$@"
        ;;
    stop)
        cmd_stop
        ;;
    status)
        cmd_status
        ;;
    list)
        cmd_list
        ;;
    devices)
        cmd_devices
        ;;
    qr)
        cmd_qr
        ;;
    ui)
        cmd_ui
        ;;
    desktop)
        cmd_desktop
        ;;
    connect)
        shift
        cmd_connect "$@"
        ;;
    pair)
        shift
        cmd_pair "$@"
        ;;
    disconnect)
        cmd_disconnect
        ;;
    help|--help|-h)
        cmd_help
        ;;
    "")
        ensure_v4l2loopback
        cd "$SCRIPT_DIR"
        bun run src/index.tsx
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'popdroidcam help' for usage."
        exit 1
        ;;
esac
