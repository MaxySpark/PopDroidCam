#!/bin/bash

STATE_DIR="$HOME/.local/state/popdroidcam"
PID_FILE="$STATE_DIR/pid"
CONFIG_FILE="$STATE_DIR/config"

SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
    DIR="$(cd "$(dirname "$SOURCE")" && pwd)"
    SOURCE="$(readlink "$SOURCE")"
    [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$(cd "$(dirname "$SOURCE")" && pwd)"

mkdir -p "$STATE_DIR"

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

find_v4l2_device() {
    for name_file in /sys/devices/virtual/video4linux/video*/name; do
        if [ -f "$name_file" ]; then
            name=$(cat "$name_file" 2>/dev/null)
            if [[ "$name" == *"Android"* ]] || [[ "$name" == *"v4l2loopback"* ]]; then
                device=$(basename "$(dirname "$name_file")")
                echo "/dev/$device"
                return 0
            fi
        fi
    done
    echo "/dev/video6"
}

ensure_v4l2loopback() {
    if ! lsmod | grep -q v4l2loopback; then
        echo -e "${YELLOW}Loading v4l2loopback module...${NC}"
        sudo modprobe v4l2loopback card_label="Android Cam" exclusive_caps=1
        sleep 1
    fi
}

is_running() {
    if [ -f "$PID_FILE" ]; then
        pid=$(cat "$PID_FILE")
        if ps -p "$pid" > /dev/null 2>&1; then
            return 0
        fi
    fi
    return 1
}

cmd_start() {
    if is_running; then
        echo -e "${YELLOW}Camera already running (PID: $(cat "$PID_FILE"))${NC}"
        echo "Use 'popdroidcam stop' to stop it first."
        exit 1
    fi

    local res="1920x1080"
    local fps="30"
    local camera="back"

    while [[ $# -gt 0 ]]; do
        case $1 in
            --res)
                case $2 in
                    1080p|1080) res="1920x1080" ;;
                    4k|4K|2160p) res="3840x2160" ;;
                    720p|720) res="1280x720" ;;
                    *) res="$2" ;;
                esac
                shift 2
                ;;
            --fps)
                fps="$2"
                shift 2
                ;;
            --camera)
                camera="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done

    if ! adb devices 2>/dev/null | grep -q "\sdevice$"; then
        echo -e "${RED}No Android device connected or authorized.${NC}"
        echo "Enable USB debugging and reconnect your phone."
        exit 1
    fi

    ensure_v4l2loopback
    local v4l2_device=$(find_v4l2_device)

    echo -e "${CYAN}Starting camera stream...${NC}"
    echo "  Resolution: $res"
    echo "  FPS: $fps"
    echo "  Camera: $camera"
    echo "  Device: $v4l2_device"

    nohup scrcpy \
        --video-source=camera \
        --camera-facing="$camera" \
        --camera-size="$res" \
        --camera-fps="$fps" \
        --v4l2-sink="$v4l2_device" \
        --no-window \
        --no-audio \
        > "$STATE_DIR/scrcpy.log" 2>&1 &

    local pid=$!
    sleep 2

    if ps -p $pid > /dev/null 2>&1; then
        echo "$pid" > "$PID_FILE"
        echo "res=$res" > "$CONFIG_FILE"
        echo "fps=$fps" >> "$CONFIG_FILE"
        echo "camera=$camera" >> "$CONFIG_FILE"
        echo "device=$v4l2_device" >> "$CONFIG_FILE"
        echo "started=$(date -Iseconds)" >> "$CONFIG_FILE"
        
        echo -e "${GREEN}✓ Camera started (PID: $pid)${NC}"
        echo "Select 'Android Cam' in your video apps."
    else
        echo -e "${RED}✗ Failed to start camera${NC}"
        echo "Check logs: cat $STATE_DIR/scrcpy.log"
        exit 1
    fi
}

cmd_stop() {
    if ! is_running; then
        echo -e "${YELLOW}Camera is not running.${NC}"
        exit 0
    fi

    local pid=$(cat "$PID_FILE")
    echo -e "${CYAN}Stopping camera (PID: $pid)...${NC}"
    kill "$pid" 2>/dev/null
    sleep 1

    if ps -p "$pid" > /dev/null 2>&1; then
        kill -9 "$pid" 2>/dev/null
    fi

    rm -f "$PID_FILE"
    echo -e "${GREEN}✓ Camera stopped${NC}"
}

cmd_status() {
    echo -e "${CYAN}=== PopDroidCam Status ===${NC}"
    echo ""

    if is_running; then
        local pid=$(cat "$PID_FILE")
        echo -e "Stream: ${GREEN}Running${NC} (PID: $pid)"
        
        if [ -f "$CONFIG_FILE" ]; then
            echo ""
            echo "Current settings:"
            while IFS='=' read -r key value; do
                printf "  %-10s %s\n" "$key:" "$value"
            done < "$CONFIG_FILE"
        fi
    else
        echo -e "Stream: ${RED}Stopped${NC}"
    fi

    echo ""
    echo "Device:"
    local device_line=$(adb devices 2>/dev/null | grep -E "\s(device|unauthorized)$" | head -1)
    if [ -n "$device_line" ]; then
        local device=$(echo "$device_line" | cut -f1)
        local state=$(echo "$device_line" | cut -f2)
        if [[ "$device" == *":"* ]]; then
            echo -e "  Phone: ${GREEN}Connected (WiFi)${NC} ($device)"
        else
            echo -e "  Phone: ${GREEN}Connected (USB)${NC} ($device)"
        fi
        if [ "$state" == "unauthorized" ]; then
            echo -e "         ${YELLOW}⚠ Unauthorized - accept prompt on phone${NC}"
        fi
    else
        echo -e "  Phone: ${RED}Not connected${NC}"
    fi

    local v4l2_device=$(find_v4l2_device)
    if [ -e "$v4l2_device" ]; then
        echo -e "  V4L2:  ${GREEN}$v4l2_device${NC}"
    else
        echo -e "  V4L2:  ${RED}Not found${NC}"
    fi
}

cmd_list() {
    echo -e "${CYAN}=== Available Cameras ===${NC}"
    echo ""
    
    if ! adb devices 2>/dev/null | grep -q "\sdevice$"; then
        echo -e "${RED}No Android device connected.${NC}"
        exit 1
    fi

    local output=$(scrcpy --video-source=camera --list-cameras 2>&1)
    
    local device_info=$(echo "$output" | grep -E "^\[server\] INFO: Device:" | sed 's/\[server\] INFO: Device: //')
    if [ -n "$device_info" ]; then
        echo -e "Device: ${GREEN}$device_info${NC}"
        echo ""
    fi

    echo "Available cameras:"
    echo "$output" | grep -E "^\s+--camera-id=" | while read line; do
        local id=$(echo "$line" | grep -oP 'camera-id=\K[0-9]+')
        local facing=$(echo "$line" | grep -oP '\(\K[^,]+')
        local resolution=$(echo "$line" | grep -oP ', \K[0-9]+x[0-9]+')
        local fps_list=$(echo "$line" | grep -oP 'fps=\[\K[^\]]+')
        
        echo ""
        echo -e "  ${CYAN}Camera $id${NC} ($facing)"
        echo "    Max Resolution: $resolution"
        echo "    Supported FPS:  $fps_list"
        echo "    Usage: popdroidcam start --camera $facing --res $resolution"
    done
    
    echo ""
    echo -e "${YELLOW}Tip:${NC} Use --res with custom resolution like --res 4080x3060"
}

cmd_devices() {
    echo -e "${CYAN}=== Connected Devices ===${NC}"
    echo ""
    
    echo "Android devices:"
    adb devices -l 2>/dev/null | tail -n +2 | while read line; do
        if [ -n "$line" ]; then
            echo "  $line"
        fi
    done

    echo ""
    echo "Video devices:"
    v4l2-ctl --list-devices 2>/dev/null || echo "  v4l2-ctl not available"
}

cmd_connect() {
    local ip="$1"
    local port="${2:-5555}"
    
    if [ -z "$ip" ]; then
        echo -e "${RED}Usage: popdroidcam connect <ip> [port]${NC}"
        echo ""
        echo "To find your phone's IP and port:"
        echo "  1. Enable Wireless debugging (Settings → Developer Options → Wireless debugging)"
        echo "  2. Tap 'Pair device with pairing code' for first-time setup"
        echo "  3. Note the IP address and Port shown"
        echo ""
        echo "Example:"
        echo "  popdroidcam connect 192.168.1.100 5555"
        exit 1
    fi
    
    echo -e "${CYAN}Connecting to $ip:$port...${NC}"
    
    if adb connect "$ip:$port" 2>&1 | grep -q "connected"; then
        echo -e "${GREEN}✓ Connected to $ip:$port${NC}"
        echo ""
        echo "Now you can use: popdroidcam start"
    else
        echo -e "${RED}✗ Failed to connect${NC}"
        echo ""
        echo "Troubleshooting:"
        echo "  1. Ensure phone and PC are on same WiFi network"
        echo "  2. Check Wireless debugging is enabled on phone"
        echo "  3. Try pairing first: popdroidcam pair <ip> <port>"
        exit 1
    fi
}

cmd_pair() {
    local ip="$1"
    local port="$2"
    local code="$3"
    
    if [ -z "$ip" ] || [ -z "$port" ]; then
        echo -e "${RED}Usage: popdroidcam pair <ip> <port> <code>${NC}"
        echo ""
        echo "To pair your phone:"
        echo "  1. Enable Wireless debugging (Settings → Developer Options → Wireless debugging)"
        echo "  2. Tap 'Pair device with pairing code'"
        echo "  3. Note the IP, Port, and Pairing code shown"
        echo ""
        echo "Example:"
        echo "  popdroidcam pair 192.168.1.100 37123 123456"
        exit 1
    fi
    
    if [ -z "$code" ]; then
        echo -e "${RED}Error: Pairing code is required${NC}"
        echo "Usage: popdroidcam pair <ip> <port> <code>"
        exit 1
    fi
    
    echo -e "${CYAN}Pairing with $ip:$port using code $code...${NC}"
    
    local output=$(adb pair "$ip:$port" "$code" 2>&1)
    echo "$output"
    
    if echo "$output" | grep -qi "success\|paired"; then
        echo -e "${GREEN}✓ Paired successfully${NC}"
        echo ""
        echo "Now connect with: popdroidcam connect <ip> <port>"
        echo "(Use the port from 'Wireless debugging' screen, not the pairing port)"
    else
        echo -e "${RED}✗ Pairing failed${NC}"
        echo ""
        echo "Troubleshooting:"
        echo "  1. Make sure the pairing code is still valid (they expire quickly)"
        echo "  2. Tap 'Pair device with pairing code' again for a fresh code"
        echo "  3. Ensure phone and PC are on same WiFi network"
        exit 1
    fi
}

cmd_disconnect() {
    echo -e "${CYAN}Disconnecting all wireless devices...${NC}"
    adb disconnect
    echo -e "${GREEN}✓ Disconnected${NC}"
}

cmd_help() {
    echo "PopDroidCam - Use Android phone as webcam"
    echo ""
    echo "Usage: popdroidcam [command] [options]"
    echo ""
    echo "Commands:"
    echo "  (none)      Launch interactive TUI"
    echo "  start       Start camera stream in background"
    echo "  stop        Stop camera stream"
    echo "  status      Show current status"
    echo "  list        List available cameras on phone with resolutions"
    echo "  devices     List connected devices"
    echo "  connect     Connect to phone over WiFi (wireless debugging)"
    echo "  pair        Pair with phone for wireless debugging (first-time)"
    echo "  disconnect  Disconnect wireless devices"
    echo "  help        Show this help"
    echo ""
    echo "Start options:"
    echo "  --res       Resolution: 720p, 1080p, 4k, or custom (e.g. 4080x3060)"
    echo "  --fps       Frame rate: 10, 15, 20, 24, 30 (default)"
    echo "  --camera    Camera: back (default), front"
    echo ""
    echo "Wireless setup (one-time):"
    echo "  1. Enable 'Wireless debugging' in Developer Options on phone"
    echo "  2. popdroidcam pair <ip> <pairing-port> <code>"
    echo "  3. popdroidcam connect <ip> <port>"
    echo ""
    echo "Examples:"
    echo "  popdroidcam start"
    echo "  popdroidcam start --res 4k --fps 30"
    echo "  popdroidcam start --res 4080x3060 --fps 30"
    echo "  popdroidcam start --camera front --res 3264x2448"
    echo "  popdroidcam connect 192.168.1.100 5555"
    echo "  popdroidcam list"
    echo "  popdroidcam stop"
}

case "${1:-}" in
    start)
        shift
        cmd_start "$@"
        ;;
    stop)
        cmd_stop
        ;;
    status)
        cmd_status
        ;;
    list)
        cmd_list
        ;;
    devices)
        cmd_devices
        ;;
    connect)
        shift
        cmd_connect "$@"
        ;;
    pair)
        shift
        cmd_pair "$@"
        ;;
    disconnect)
        cmd_disconnect
        ;;
    help|--help|-h)
        cmd_help
        ;;
    "")
        ensure_v4l2loopback
        cd "$SCRIPT_DIR"
        if [ -d "venv" ]; then
            source venv/bin/activate
        fi
        python3 cam_tui.py
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'popdroidcam help' for usage."
        exit 1
        ;;
esac
